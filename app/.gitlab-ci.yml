# GitLab CI/CD configuration for React Vite app
image: node:20-alpine

# Global cache configuration
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/
  policy: pull-push

# Define stages
stages:
  - build
  - deploy

# Variables for optimization
variables:
  NODE_ENV: "production"
  CI: "true"

# Build stage
build:
  stage: build
  timeout: 30m
  before_script:
    - echo "Node version:" && node --version
    - echo "NPM version:" && npm --version
    - echo "Installing dependencies..."
  script:
    - npm install
    - echo "Building application..."
    - npm run build
    - echo "Build completed successfully!"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - .npm/
    policy: pull-push
  only:
    - main
    - master

# Deploy to GitLab Pages
pages:
  stage: deploy
  image: alpine:latest
  before_script:
    - echo "Preparing deployment..."
  script:
    - mkdir public
    - cp -r dist/* public/
    - echo "Files copied to public directory:"
    - ls -la public/
    - echo "Deployment ready!"
  artifacts:
    paths:
      - public
    expire_in: 30 days
  dependencies:
    - build
  cache: {}
  only:
    - main
    - master
